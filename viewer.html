<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bus Map Viewer</title>
<style>
html, body { margin:0; height:100%; font-family: Arial, sans-serif; }
#mapCanvas { height:100%; width:100%; display:flex; justify-content:center; align-items:center; background:#f3f4f6; }
svg { width:92%; height:92%; max-width:100%; max-height:100%; }
.lane { fill:none; stroke-width:30; stroke-linecap:round; }
.lane1 { stroke:#2563eb; }
.lane2 { stroke:#16a34a; }
.lane3 { stroke:#f59e0b; }
.bus text { font-size:28px; font-weight:700; fill:#000; text-anchor:middle; dominant-baseline:middle; pointer-events:none; }
#notArrived rect { fill:#f9fafb; stroke:#6b7280; stroke-dasharray:6 4; }
#notArrived text { fill:#111827; font-weight:bold; }
#departed rect { fill:#e0e7ff; stroke:#4f46e5; stroke-dasharray:6 4; }
#departed text { fill:#1e3a8a; font-weight:bold; }
</style>
</head>
<body>
<div id="mapCanvas">
<svg id="busMap" viewBox="0 0 1000 700">
  <path class="lane lane1" d="M180,100 L180,480 Q400,540 620,480 L620,100" />
  <path class="lane lane2" d="M240,140 L240,440 Q400,490 560,440 L560,140" />
  <path class="lane lane3" d="M300,180 L300,400 Q400,440 500,400 L500,180" />

  <!-- Flagpole (US flag) -->
  <g id="flagpole" transform="translate(80,500)">
    <rect x="0" y="-100" width="6" height="120" fill="#444"/>
    <rect x="6" y="-95" width="50" height="30" fill="#b22234" stroke="black"/>
    <rect x="6" y="-95" width="50" height="4" fill="white"/>
    <rect x="6" y="-87" width="50" height="4" fill="white"/>
    <rect x="6" y="-79" width="50" height="4" fill="white"/>
    <rect x="6" y="-71" width="50" height="4" fill="white"/>
    <rect x="6" y="-95" width="20" height="16" fill="#3c3b6e"/>
    <circle cx="10" cy="-91" r="1.5" fill="white"/>
    <circle cx="16" cy="-91" r="1.5" fill="white"/>
    <circle cx="10" cy="-85" r="1.5" fill="white"/>
    <circle cx="16" cy="-85" r="1.5" fill="white"/>
  </g>

  <g id="notArrived" transform="translate(100,560)">
    <rect width="600" height="100" rx="12" ry="12" />
    <text x="300" y="55" text-anchor="middle">Not Arrived</text>
  </g>
  <g id="departed" transform="translate(800,20)">
    <rect width="180" height="600" rx="10" ry="10" />
    <text x="90" y="30" text-anchor="middle">Departed</text>
  </g>
</svg>
</div>

<script>
const REPO_OWNER = "andrewposner-byte";
const REPO_NAME = "Bus-Duty-Map";
let buses = [];

function renderBuses() {
  const busMap = document.getElementById("busMap");
  document.querySelectorAll(".bus").forEach(el => el.remove());
  if (!Array.isArray(buses)) return;

  buses.forEach(bus => {
    const g = document.createElementNS("http://www.w3.org/2000/svg","g");
    g.setAttribute("class","bus");
    g.setAttribute("transform",`translate(${bus.x},${bus.y})`);

    const body = document.createElementNS("http://www.w3.org/2000/svg","rect");
    body.setAttribute("x",0); body.setAttribute("y",10);
    body.setAttribute("width",120); body.setAttribute("height",40);
    body.setAttribute("rx",8); body.setAttribute("ry",8);
    body.setAttribute("fill","#FFD600"); body.setAttribute("stroke","black");

    const wheel1 = document.createElementNS("http://www.w3.org/2000/svg","circle");
    wheel1.setAttribute("cx",25); wheel1.setAttribute("cy",55); wheel1.setAttribute("r",8); wheel1.setAttribute("fill","black");
    const wheel2 = document.createElementNS("http://www.w3.org/2000/svg","circle");
    wheel2.setAttribute("cx",95); wheel2.setAttribute("cy",55); wheel2.setAttribute("r",8); wheel2.setAttribute("fill","black");

    const text = document.createElementNS("http://www.w3.org/2000/svg","text");
    text.setAttribute("x",60); text.setAttribute("y",38);
    text.setAttribute("font-size","28");
    text.setAttribute("font-weight","bold"); 
    text.setAttribute("text-anchor","middle");
    text.textContent = bus.id;

    g.appendChild(body);
    g.appendChild(wheel1);
    g.appendChild(wheel2);
    g.appendChild(text);

    busMap.appendChild(g);
  });
}

async function loadBuses() {
  try {
    const res = await fetch(`https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/map-state-midday.json?_=${Date.now()}`);
    if(!res.ok) throw new Error(`Fetch error: ${res.status}`);
    const data = await res.json();
    buses = data.buses || [];
    renderBuses();
  } catch(err) { console.error("Load error:", err); }
}

setInterval(loadBuses, 2000);
loadBuses();
</script>
</body>
</html>
